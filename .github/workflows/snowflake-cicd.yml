on:
  push:
    branches:
      - dev
      - qa
      - pre-prod
      - prod
        
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (dev, qa, pre_prod, prod)'
        required: true
        default: dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || github.ref_name }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set ENV Variable based on Branch
        run: echo "DEPLOY_ENV=${{ github.event.inputs.environment || github.ref_name }}" >> $GITHUB_ENV

      - name: Install Python and pip (Ubuntu/Debian)
        run: |
          sudo apt-get install -y python3 python3-pip 

      - name: Verify Python and pip installation, Install Snowflake CLI via pip
        run: |
          python3 -m pip install pipx
          pipx install snowflake-cli
          snow --version

      - name: SNOWFLAKE CLI INSTALLATION
        uses: Snowflake-Labs/snowflake-cli-action@v1.5
        with:
          cli-version: "latest"
          default-config-file-path: ${{ github.workspace }}/config/config.toml

      - name: Test Snowflake Connection
        run: |
          snow sql -q "SELECT CURRENT_USER(), CURRENT_ROLE(), CURRENT_DATABASE(), CURRENT_WAREHOUSE();"
        
      # - name: Deploy SQL Scripts
      #   run: |
      #     chmod +x deploymentScript/deploy.sh
      #     ./deploymentScript/deploy.sh ${{ github.event.inputs.environment }}
